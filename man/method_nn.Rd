% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/method_nn.R
\name{method_nn}
\alias{method_nn}
\title{Mass imputation using nearest neighbours matching method}
\usage{
method_nn(
  y_nons,
  X_nons,
  X_rand,
  svydesign,
  weights = NULL,
  family_outcome = NULL,
  start_outcome = NULL,
  vars_selection = FALSE,
  pop_totals = NULL,
  pop_size = NULL,
  control_outcome = control_out(),
  control_inference = control_inf(),
  verbose = FALSE,
  se = TRUE
)
}
\arguments{
\item{y_nons}{target variable from non-probability sample}

\item{X_nons}{a \code{model.matrix} with auxiliary variables from non-probability sample}

\item{X_rand}{a \code{model.matrix} with auxiliary variables from non-probability sample}

\item{svydesign}{a svydesign object}

\item{weights}{case / frequency weights from non-probability sample}

\item{family_outcome}{a placeholder (not used in \code{method_nn})}

\item{start_outcome}{a placeholder (not used in \code{method_nn})}

\item{vars_selection}{whether variable selection should be conducted}

\item{pop_totals}{a placeholder (not used in \code{method_nn})}

\item{pop_size}{population size from the \code{nonprob} function}

\item{control_outcome}{controls passed by the \code{control_out} function}

\item{control_inference}{controls passed by the \code{control_inf} function}

\item{verbose}{parameter passed from the main \code{nonprob} function}

\item{se}{whether standard errors should be calculated}
}
\value{
an \code{nonprob_method} class which is a \code{list} with the following entries

\describe{
\item{model_fitted}{\code{RANN::nn2} object}
\item{y_nons_pred}{predicted values for the non-probablity sample (query to itself)}
\item{y_rand_pred}{predicted values for the probability sample}
\item{coefficients}{coefficients for the model (if available)}
\item{svydesign}{an updated \code{surveydesign2} object (new column \code{y_hat_MI} is added)}
\item{y_mi_hat}{estimated population mean for the target variable}
\item{vars_selection}{whether variable selection was performed (not implemented, for further development)}
\item{var_prob}{variance for the probability sample component (if available)}
\item{var_nonprob}{variance for the non-probability sample component}
\item{var_tot}{total variance, if possible it should be \code{var_prob+var_nonprob} if not, just a scalar}
\item{model}{model type (character \code{"nn"})}
\item{family}{placeholder for the \verb{NN approach} information}
}
}
\description{
Mass imputation using nearest neighbours approach as described in Yang (2021).
The implementation is currently based on \link[RANN:nn2]{RANN::nn2} function and thus it uses
Euclidean distance to matching.

This implementation extends Yang (2021) approach as described in Chlebicki et al. (2025), namely:

\describe{
\item{pmm_weights}{if k>1 weighted aggregation of the mean for a given unit is used. We use distance
matrix returned by \link[RANN:nn2]{RANN::nn2} function (\code{pmm_weights} from the \code{\link[=control_out]{control_out()}} function)}
\item{nn_exact_se}{if the non-probability sample is small we recommend using a mini-bootstrap
approach to estimate variance from the non-probability sample  (\code{nn_exact_se} from the \code{\link[=control_inf]{control_inf()}} function)}
\item{pmm_k_choice}{the main \code{nonprob} function allows for dynamic selection of \code{k} neighbours based on the
variance minimization procedure (\code{pmm_k_choice} from the \code{\link[=control_out]{control_out()}} function)}
}
}
\details{
\loadmathjax

Analytical variance

The variance of the mean is estimated based on the following approach

(a) non-probability part

This may be estimated using

\mjsdeqn{
\hat{V}_1 = \frac{1}{N^2}\sum_{i=1}^{S_A}\frac{1-\hat{\pi}_B(\boldsymbol{x}_i)}{\hat{\pi}_B(\boldsymbol{x}_i)}\hat{\sigma}^2(\boldsymbol{x}_i)
}

or

\mjsdeqn{
\hat{V}_1 = \frac{1}{N^2}\sum_{i=1}^{S_A}\frac{1}{\hat{\pi}_B(\boldsymbol{x}_i)}(y_i - y_i^*)
}

or mini-bootstrap

(b) probability part

This part uses functionalities of the \code{{survey}} package and the variance is estimated using the following
equation:

\mjsdeqn{
\hat{V}_1=\frac{1}{N^2} \sum_{i=1}^n \sum_{j=1}^n \frac{\pi_{i j}-\pi_i \pi_j}{\pi_{i j}}
\frac{y_i^*}{\pi_i} \frac{y_j^*}{\pi_j}
}

where \mjseqn{y^*_i} and \mjseqn{y_j^*} are values imputed imputed as an average of \mjseqn{k}-nearest neighbour,
i.e. \mjseqn{{k}^{-1}\sum_{k}y_k}.
}
\examples{

data(admin)
data(jvs)
jvs_svy <- svydesign(ids = ~ 1,  weights = ~ weight, strata = ~ size + nace + region, data = jvs)

res_nn <- method_nn(y_nons = admin$single_shift,
                    X_nons = model.matrix(~ region + private + nace + size, admin),
                    X_rand = model.matrix(~ region + private + nace + size, jvs),
                    svydesign = jvs_svy)

res_nn

}
\references{
Yang, S., Kim, J. K., & Hwang, Y. (2021). Integration of data from probability surveys and
big found data for finite population inference using mass imputation.
Survey Methodology, June 2021 29 Vol. 47, No. 1, pp. 29-58

Chlebicki, P., Chrostowski, Ł., & Beręsewicz, M. (2025). Data integration of non-probability
and probability samples with predictive mean matching. arXiv preprint arXiv:2403.13750.
}
